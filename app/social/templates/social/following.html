{% extends "social/base.html" %} {% block content %}

<div class="container mt-4">
	<h2>Users You're Following</h2>
    {%if following_authors%}
        {%for author in following_authors%}
        <ul>
            <li>
                <strong>{{ author.displayName }}</strong> ({{ author.id }}) 
                <button class="unfollow-button btn btn-danger btn-sm" aria-label="Unfollow {{ author.displayName }}" data-author-id="{{ author.id }}" data-author-name="{{ author.displayName }}">Unfollow ❌</button>
            </li>
        </ul>
        {% endfor%}
    {% else%}
  
	<p>You're not following anyone yet.</p>{% endif %}

</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".unfollow-button").forEach(button => {
            button.onclick = async function () {
                let authorId = this.getAttribute("data-author-id");
                let authorName = this.getAttribute("data-author-name");
                let myAuthorId = "{{ my_author_id }}";  // Logged-in author's ID
                
                let confirmUnfollow = confirm(`Are you sure you want to unfollow ${authorName}?`);
                if (!confirmUnfollow) return;

                // ✅ Send DELETE request to `/unfollow/` URL
                let unfollowUrl = `/social/unfollow/`;

                console.log("Unfollowing author:", authorId);

                let response = await fetch(unfollowUrl, { 
                    method: "DELETE",
                    headers: { "Content-Type": "application/json",
                            "X-CSRFToken": getCookie("csrftoken")
                     },
                    body: JSON.stringify({ followee_id: authorId })  //  Send followee ID in request body
                });

                let result = await response.json();
                if (response.ok) {
                    alert(result.message || "Unfollowed successfully.");
                    this.parentElement.remove();  //  Remove from UI
                    location.reload(); 
                } else {
                    alert(result.error || "Error unfollowing.");
                }
            };
        });
    });
</script> {% endblock %}