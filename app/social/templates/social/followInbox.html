<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Follow Requests</title>
</head>
<body>

    <h2>Follow Requests</h2>

    <ul id="follow-requests-list">
        <li>Loading...</li>
    </ul>

    <script>
        const MY_AUTHOR_ID = "http://localhost:8000/api/authors/333333333";  // hard-coded to check

        async function loadFollowRequests() {
            let response = await fetch(`/api/authors/${encodeURIComponent(MY_AUTHOR_ID)}/inbox/`);
            let data = await response.json();

            let list = document.getElementById("follow-requests-list");
            list.innerHTML = ""; // Clear the loading text

            if (!data.items || data.items.length === 0) {
                list.innerHTML = "<li>No pending follow requests</li>";
                return;
            }

            data.items.forEach(request => {
            if (request.type === "follow") {
                let actorName = request.actor.displayName || "Unknown Author";  // Ensure fallback name

                let li = document.createElement("li");
                li.innerHTML = `
                    <b>${actorName}</b> wants to follow you.
                    <button class="approve-button" data-actor-id="${request.actor.id}">Approve</button>
                    <button class="deny-button" data-actor-id="${request.actor.id}">Deny</button>
                `;
                list.appendChild(li);
            }
            });


            document.querySelectorAll(".approve-button").forEach(button => {
                button.onclick = async function() {
                    let actorId = this.getAttribute("data-actor-id");
                    await approveFollowRequest(actorId);
                };
            });

            document.querySelectorAll(".deny-button").forEach(button => {
                button.onclick = async function() {
                    let actorId = this.getAttribute("data-actor-id");
                    await denyFollowRequest(actorId);
                };
            });
        }

        async function approveFollowRequest(actorId) {
            let response = await fetch(`/api/authors/${encodeURIComponent(MY_AUTHOR_ID)}/followers/${encodeURIComponent(actorId)}/`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" }
            });

            let result = await response.json();
            alert(result.message || result.error);
            loadFollowRequests();  // Refresh the list
        }


        async function denyFollowRequest(actorId) {
            await removeFromInbox(actorId);
            alert("Follow request denied!");
            loadFollowRequests();  // Refresh the list
        }

        async function removeFromInbox(actorId) {
            let response = await fetch(`/api/authors/${encodeURIComponent(MY_AUTHOR_ID)}/inbox/`, {
                method: "DELETE",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ actorId })  // Send actor ID to remove the specific request
            });

            let result = await response.json();
            if (!response.ok) {
                alert(result.error || "Failed to remove request from inbox.");
            }
        }
        async function denyFollowRequest(actorId) {
            let response = await fetch(`/api/authors/${encodeURIComponent(MY_AUTHOR_ID)}/followers/${encodeURIComponent(actorId)}/`, {
                method: "DELETE",
                headers: { "Content-Type": "application/json" }
            });

            let result = await response.json();
            alert(result.message || result.error);
            loadFollowRequests();  // Refresh the list
        }


        // Load follow requests when the page loads
        loadFollowRequests();
    </script>

</body>
</html>
