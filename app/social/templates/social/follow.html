{% extends "social/base.html" %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4 text-center fw-bold">Follow Authors</h1>

    <h4 class="text-center">Follow Remote Authors</h4>
    <select id="node-select" class="form-select mb-3">
        <option value="">-- Select a node --</option>
        {% for node in nodes %}
            <option value="{{ node.base_url }}">{{ node.name }} - {{ node.base_url }}</option>
        {% endfor %}
    </select>
    <div id="remote-authors" class="mb-4"></div>

    <h4 class="mb-4 text-center">Local Authors</h4>
    {% if authors %}
        <ul>
        {% for author in authors %}
            <li>
                <button class="follow-button btn btn-primary btn-sm" 
                        data-author-id="{{ author.id }}" 
                        data-author-name="{{ author.displayName }}"
                        data-author-host="{{ author.host }}"
                        data-author-github="{{ author.github|default:'' }}"
                        data-author-profileImage="{{ author.profileImage|default:'' }}"
                        data-author-page="{{ author.page|default:'' }}">
                    Follow {{ author.displayName }} ({{ author.id }})
                </button>
            </li>
        {% endfor %}
        </ul>
    {% else %}
        <p class="text-center">No authors available</p>  
    {% endif %}
</div>

<script>

    var THIS_USER_ID = ""

    const MY_AUTHOR_ID = "{{ my_author.id|escapejs }}";
    const MY_AUTHOR_NAME = "{{ my_author.displayName|escapejs }}";
    const MY_AUTHOR_HOST = "{{ my_author.host|escapejs }}";
    const MY_AUTHOR_GITHUB = "{{ my_author.github|escapejs }}";
    const MY_AUTHOR_PROFILE_IMAGE = "{{ my_author.profileImage|escapejs }}";
    const MY_AUTHOR_PAGE = "{{ my_author.page|escapejs }}";

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function attachFollowHandlers() {
    document.querySelectorAll(".follow-remote, .follow-button").forEach(button => {
        button.onclick = async function () {
            let authorId = this.getAttribute("data-author-id");
            let authorName = this.getAttribute("data-author-name");
            let authorHost = this.getAttribute("data-author-host");
            let authorGithub = this.getAttribute("data-author-github");
            let authorProfileImage = this.getAttribute("data-author-profileImage");
            let authorPage = this.getAttribute("data-author-page");

            let confirmFollow = confirm(`Are you sure you want to follow ${authorName}?`);
            if (!confirmFollow) return;

            try {
                let response = await fetch("/social/api/follow/confirm/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCookie("csrftoken")
                    },
                    body: JSON.stringify({
                        followee_id: authorId,
                        displayName: authorName,
                        host: authorHost || "",
                        github: authorGithub || "",
                        profileImage: authorProfileImage || "",
                        page: authorPage || "",
                        summary: `${MY_AUTHOR_NAME} wants to follow ${authorName}`,
                        userId: THIS_USER_ID
                    })
                });

                let result = await response.json();
                if (response.ok) {
                    alert("Follow request processed!");
                    location.reload();
                } else {
                    alert(result.error || "Error processing follow request.");
                    console.log(result);
                }
            } catch (err) {
                alert("Network error processing follow request.");
                console.error(err);
            }
        };
    });
}


    document.addEventListener("DOMContentLoaded", function () {
        attachFollowHandlers();

        document.getElementById("node-select").addEventListener("change", async function () {
            const selectedNode = this.value;
            if (!selectedNode) return;

            try {
                const response = await fetch(`/social/remote-authors/?node=${encodeURIComponent(selectedNode)}`);
                const data = await response.json();
                THIS_USER_ID = data.user;

                console.log(THIS_USER_ID);
                const authors = data.authors || [];

                const container = document.getElementById("remote-authors");
                container.innerHTML = "<h4 class='mb-4 text-center'>Remote Authors</h4><ul>";

                authors.forEach(author => {
                    container.innerHTML += `
                        <li>
                            <button class="follow-remote btn btn-secondary btn-sm"
                                data-author-id="${author.id}"
                                data-author-name="${author.displayName || 'Unknown'}"
                                data-author-host="${author.host || selectedNode}"
                                data-author-github="${author.github || ''}"
                                data-author-profileImage="${author.profileImage || ''}"
                                data-author-page="${author.page || ''}">
                                Follow ${author.displayName || 'Unknown'} (${author.id})
                            </button>
                        </li>`;
                });

                container.innerHTML += "</ul>";
                attachFollowHandlers();
            } catch (err) {
                alert("Failed to load authors from your backend.");
                console.error(err);
            }
        });

    });
</script>
{% endblock %}
